<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>অনলাইন হাজিরা সিস্টেম</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <style>
    body { background: #f7f7f7; padding: 20px; }
    .container { max-width: 1000px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .weekend { background-color: #f8f9fa; }
    .error { color: #dc3545; font-size: 0.9em; margin-top: 5px; }
    @media print {
      button, .daily-entry, .print-hide { display: none !important; }
      .container { box-shadow: none; padding: 0; margin: 0; }
      .table { border-collapse: collapse; }
      .table th, .table td { border: 1px solid #000 !important; }
      .print-show { display: block !important; margin-bottom: 20px; }
    }
    .print-show { display: none; }
  </style>
</head>
<body>
  <!-- লগিন কন্টেইনার -->
  <div id="authContainer" class="container print-hide">
    <h1 class="text-center mb-4">লগিন/রেজিস্টার</h1>
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="mb-3">
          <input type="email" id="email" class="form-control" placeholder="ইমেইল ঠিকানা">
        </div>
        <div class="mb-3">
          <input type="password" id="password" class="form-control" placeholder="পাসওয়ার্ড">
        </div>
        <div class="d-grid gap-2">
          <button onclick="login()" class="btn btn-primary">লগিন করুন</button>
          <button onclick="signUp()" class="btn btn-success">নতুন অ্যাকাউন্ট তৈরি করুন</button>
          <button onclick="googleLogin()" class="btn btn-danger">Google দিয়ে লগিন</button>
        </div>
        <div id="authError" class="error mt-2"></div>
      </div>
    </div>
  </div>

  <!-- মেইন অ্যাপ্লিকেশন -->
  <div id="mainContainer" class="container" style="display: none;">
    <!-- প্রিন্ট হেডার -->
    <div class="print-show">
      <h2 class="text-center">কর্মীর মাসিক হাজিরা রিপোর্ট</h2>
      <div class="row">
        <div class="col-6">
          <p>নাম: <span id="printName"></span></p>
          <p>আইডি: <span id="printId"></span></p>
        </div>
        <div class="col-6 text-end">
          <p>মাস: <span id="printMonth"></span></p>
          <p>বছর: <span id="printYear"></span></p>
        </div>
      </div>
    </div>

    <!-- কর্মীর তথ্য -->
    <div class="employee-info mb-4 print-hide">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">কর্মীর নাম:</label>
          <input type="text" id="employeeName" class="form-control" readonly>
        </div>
        <div class="col-md-6">
          <label class="form-label">ইমেইল:</label>
          <input type="email" id="employeeEmail" class="form-control" readonly>
        </div>
      </div>
    </div>

    <!-- মাস নির্বাচন -->
    <div class="month-year-selection mb-4 print-hide">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">মাস:</label>
          <select id="monthSelect" class="form-select">
            <option value="0">জানুয়ারী</option>
            <option value="1">ফেব্রুয়ারী</option>
            <option value="2">মার্চ</option>
            <option value="3">এপ্রিল</option>
            <option value="4">মে</option>
            <option value="5">জুন</option>
            <option value="6">জুলাই</option>
            <option value="7">আগস্ট</option>
            <option value="8">সেপ্টেম্বর</option>
            <option value="9">অক্টোবর</option>
            <option value="10">নভেম্বর</option>
            <option value="11">ডিসেম্বর</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">বছর:</label>
          <select id="yearSelect" class="form-select"></select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button id="loadMonth" class="btn btn-primary w-100">ডাটা লোড করুন</button>
        </div>
      </div>
    </div>

    <!-- দৈনিক এন্ট্রি -->
    <div class="daily-entry mb-4 print-hide">
      <h2 class="mb-3">দৈনিক এন্ট্রি</h2>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">তারিখ:</label>
          <input type="date" id="entryDate" class="form-control">
          <span id="dateError" class="error"></span>
        </div>
        <div class="col-md-4">
          <label class="form-label">হাজিরা:</label>
          <select id="attendanceStatus" class="form-select">
            <option value="">নির্বাচন করুন</option>
            <option value="present">উপস্থিত</option>
            <option value="absent">অনুপস্থিত</option>
          </select>
          <span id="attendanceError" class="error"></span>
        </div>
        <div class="col-md-4">
          <label class="form-label">ওভারটাইম (ঘণ্টা):</label>
          <input type="number" id="overtimeInput" class="form-control" min="0" step="0.5" placeholder="0">
        </div>
        <div class="col-12">
          <button id="saveEntry" class="btn btn-primary w-100">সেভ করুন</button>
        </div>
      </div>
    </div>

    <!-- ডাটা টেবিল -->
    <div class="monthly-table">
      <h2 class="mb-3 print-hide">মাসিক সারাংশ</h2>
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>তারিখ</th>
              <th>হাজিরা</th>
              <th>ওভারটাইম</th>
            </tr>
          </thead>
          <tbody id="attendanceTable"></tbody>
        </table>
      </div>
      
      <div class="d-flex justify-content-center gap-2 mt-3 print-hide">
        <button id="calculateBtn" class="btn btn-success">মোট হিসাব</button>
        <button id="printBtn" class="btn btn-primary">প্রিন্ট</button>
      </div>
      <div id="result" class="mt-3 p-3 bg-light rounded"></div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDjutN8p9j4XdAi_I_3-oWqiD1AbmdSdnM",
  authDomain: "online-data-6dcae.firebaseapp.com",
  projectId: "online-data-6dcae",
  storageBucket: "online-data-6dcae.firebasestorage.app",
  messagingSenderId: "848937873609",
  appId: "1:848937873609:web:51f1625a9ee7bf45bcdd18",
  measurementId: "G-41Q88XT5J5"
};

    // Firebase ইনিশিয়ালাইজ
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ডম রেফারেন্স
    const elements = {
      authContainer: document.getElementById('authContainer'),
      mainContainer: document.getElementById('mainContainer'),
      employeeName: document.getElementById('employeeName'),
      employeeEmail: document.getElementById('employeeEmail'),
      monthSelect: document.getElementById('monthSelect'),
      yearSelect: document.getElementById('yearSelect'),
      entryDate: document.getElementById('entryDate'),
      attendanceStatus: document.getElementById('attendanceStatus'),
      overtimeInput: document.getElementById('overtimeInput'),
      attendanceTable: document.getElementById('attendanceTable'),
      result: document.getElementById('result')
    };

    // বছর সিলেক্ট অপশন
    const currentYear = new Date().getFullYear();
    for(let y = currentYear - 5; y <= currentYear + 5; y++){
      const option = document.createElement('option');
      option.value = y;
      option.textContent = y;
      elements.yearSelect.appendChild(option);
    }
    elements.yearSelect.value = currentYear;

    // অথেন্টিকেশন স্টেট লিসেনার
    auth.onAuthStateChanged(async (user) => {
      if(user) {
        elements.authContainer.style.display = 'none';
        elements.mainContainer.style.display = 'block';
        await loadUserData(user);
      } else {
        elements.authContainer.style.display = 'block';
        elements.mainContainer.style.display = 'none';
      }
    });

    async function loadUserData(user) {
      const userDoc = await db.collection('users').doc(user.uid).get();
      if(userDoc.exists) {
        const userData = userDoc.data();
        elements.employeeName.value = userData.name || '';
        elements.employeeEmail.value = user.email;
      }
      renderTable();
    }

    // ডেটা সেভ ফাংশন
    async function saveEntry() {
      const day = new Date(elements.entryDate.value).getDate();
      const monthYear = `${elements.yearSelect.value}-${parseInt(elements.monthSelect.value)+1}`;
      
      await db.collection('users').doc(auth.currentUser.uid)
        .collection('attendance').doc(monthYear)
        .set({
          [day]: {
            attendance: elements.attendanceStatus.value,
            overtime: elements.overtimeInput.value || '0',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          }
        }, { merge: true });

      renderTable();
      elements.entryDate.value = '';
      elements.attendanceStatus.value = '';
      elements.overtimeInput.value = '';
    }

    // টেবিল রেন্ডার
    async function renderTable() {
      const monthYear = `${elements.yearSelect.value}-${parseInt(elements.monthSelect.value)+1}`;
      const docRef = db.collection('users').doc(auth.currentUser.uid)
                       .collection('attendance').doc(monthYear);
      
      const doc = await docRef.get();
      const data = doc.exists ? doc.data() : {};

      const daysInMonth = new Date(elements.yearSelect.value, 
        parseInt(elements.monthSelect.value) + 1, 0).getDate();

      let tableHTML = '';
      for(let day = 1; day <= daysInMonth; day++){
        const entry = data[day] || {};
        const isWeekend = [0, 6].includes(
          new Date(elements.yearSelect.value, elements.monthSelect.value, day).getDay()
        );

        tableHTML += `
          <tr class="${isWeekend ? 'weekend' : ''}">
            <td>${day}</td>
            <td>${entry.attendance === 'present' ? 'উপস্থিত' : 'অনুপস্থিত'}</td>
            <td>${entry.overtime || '0'}</td>
          </tr>
        `;
      }
      elements.attendanceTable.innerHTML = tableHTML;
    }

    // ইভেন্ট লিসেনার
    document.getElementById('loadMonth').addEventListener('click', renderTable);
    document.getElementById('saveEntry').addEventListener('click', saveEntry);
    document.getElementById('printBtn').addEventListener('click', () => window.print());

    // অথেন্টিকেশন ফাংশন
    async function login() {
      try {
        await auth.signInWithEmailAndPassword(
          document.getElementById('email').value,
          document.getElementById('password').value
        );
      } catch (error) {
        document.getElementById('authError').textContent = error.message;
      }
    }

    async function signUp() {
      try {
        const credential = await auth.createUserWithEmailAndPassword(
          document.getElementById('email').value,
          document.getElementById('password').value
        );
        await db.collection('users').doc(credential.user.uid).set({
          name: document.getElementById('email').value.split('@')[0],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        document.getElementById('authError').textContent = error.message;
      }
    }

    async function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        await db.collection('users').doc(result.user.uid).set({
          name: result.user.displayName,
          email: result.user.email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } catch (error) {
        document.getElementById('authError').textContent = error.message;
      }
    }
  </script>
</body>
</html>